import streamlit as st
import plotly.express as px
import pandas as pd

from dashboard.data_loader import load


def run(context=None):
    scan_type = (context or {}).get("scan_type", "Normal")

    st.subheader("Vulnerability Insights (Layer 2)")

    df = load("/vulnerabilities", scan_type)

    if df is None or getattr(df, "empty", True):
        st.info("No vulnerability data available")
        return

    df.columns = [c.lower() for c in df.columns]

    total_vulns = len(df)
    unique_cves = int(df["cve"].nunique()) if "cve" in df.columns else 0
    critical = (
        int(df["severity"].astype(str).str.upper().eq("CRITICAL").sum())
        if "severity" in df.columns
        else 0
    )

    k1, k2, k3 = st.columns(3)
    k1.metric("Total Vulnerabilities", total_vulns)
    k2.metric("Unique CVEs", unique_cves)
    k3.metric("Critical", critical)

    st.markdown("---")

    plotly_template = st.session_state.get("plotly_template", "plotly_dark")

    if "severity" in df.columns:
        sev_counts = df["severity"].astype(str).str.upper().value_counts()
        fig = px.bar(
            sev_counts.reset_index().rename(
                columns={"index": "severity", "severity": "count"}
            ),
            x="severity",
            y="count",
            title="Findings by Severity",
            template=plotly_template,
        )
        st.plotly_chart(fig, use_container_width=True)

    if "cvss" in df.columns:
        try:
            cvss = pd.to_numeric(df["cvss"], errors="coerce").dropna()
            if not cvss.empty:
                fig2 = px.histogram(
                    cvss,
                    x=cvss,
                    nbins=20,
                    title="CVSS Score Distribution",
                    template=plotly_template,
                )
                st.plotly_chart(fig2, use_container_width=True)
        except Exception:
            pass

    st.markdown("---")
    st.markdown("**Raw Vulnerability Records**")
    st.dataframe(df, use_container_width=True)

import re

NOTE_TEXT = (
    "Enumerated CVEs represent all vulnerabilities associated with "
    "the detected service/version. Displayed CVEs show only the most "
    "severe issues for clarity."
)


def _cvss_to_severity(score: float) -> str:
    if score >= 9.0:
        return "CRITICAL"
    elif score >= 7.0:
        return "HIGH"
    elif score >= 4.0:
        return "MEDIUM"
    elif score > 0:
        return "LOW"
    return "INFO"


def enrich_hosts_with_vulnerabilities(hosts: dict) -> dict:
    severity_rank = ["INFO", "LOW", "MEDIUM", "HIGH", "CRITICAL"]

    for host_data in hosts.values():
        total_vulns = 0
        overall_severity = "INFO"

        for service in host_data["services"]:
            normalized = {}

            for entry in service.get("vulnerabilities", []):
                output = entry.get("output", "")
                for line in output.splitlines():
                    match = re.search(r"(CVE-\d{4}-\d+)\s+([\d.]+)", line)
                    if match:
                        cve_id = match.group(1)
                        cvss = float(match.group(2))
                        if cve_id not in normalized:
                            normalized[cve_id] = {
                                "cve": cve_id,
                                "cvss": cvss,
                                "severity": _cvss_to_severity(cvss),
                            }

            sorted_vulns = sorted(
                normalized.values(),
                key=lambda x: x["cvss"],
                reverse=True,
            )[:5]

            service["vulnerabilities"] = sorted_vulns
            service["vulnerability_context"] = {
                "enumerated_cves": len(normalized),
                "displayed_cves": len(sorted_vulns),
                "note": NOTE_TEXT,
            }

            top_sev = sorted_vulns[0]["severity"] if sorted_vulns else "NONE"
            service["security_summary"] = {"top_severity": top_sev}

            total_vulns += len(normalized)
            if sorted_vulns:
                if severity_rank.index(top_sev) > severity_rank.index(overall_severity):
                    overall_severity = top_sev

        host_data["risk_summary"] = {
            "total_vulnerabilities": total_vulns,
            "overall_risk": overall_severity if total_vulns else "INFO",
            "risk_points": total_vulns * 5,
        }

    return hosts
